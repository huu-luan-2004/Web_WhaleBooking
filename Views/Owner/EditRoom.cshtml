@{
    ViewData["Title"] = "Sửa phòng";
    var accId = Context.Request.Query["accommodationId"].ToString();
    if (string.IsNullOrWhiteSpace(accId)) accId = Context.Request.Query["coSoId"].ToString();
    var id = Context.Request.Query["id"].ToString();
}

<h3 class="mt-4">Sửa phòng #@id @(!string.IsNullOrWhiteSpace(accId) ? $"(Cơ sở #{accId})" : "")</h3>
<div id="alertMessage" class="alert d-none" role="alert"></div>

<form id="frm" class="mt-3">
    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Tên phòng</label>
            <input name="tenPhong" class="form-control" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Giá</label>
            <input name="gia" type="number" min="0" step="1000" class="form-control" />
        </div>
        <div class="col-md-6">
            <label class="form-label">Số người tối đa</label>
            <input name="soNguoiToiDa" type="number" min="1" class="form-control" />
        </div>
        <div class="col-md-12">
            <label class="form-label">Mô tả</label>
            <textarea name="moTa" rows="3" class="form-control"></textarea>
        </div>
        <div class="col-md-6">
            <label class="form-label">Thêm ảnh (có thể chọn nhiều)</label>
            <input type="file" name="files" multiple accept="image/*" class="form-control" />
            <div id="imgHint" class="form-text">Để trống nếu không thêm ảnh mới</div>
        </div>
        <div class="col-12">
            <label class="form-label">Ảnh hiện tại</label>
            <div id="roomImages" class="d-flex flex-wrap gap-2"></div>
        </div>
    </div>

    <div class="mt-3 d-flex gap-2">
        <button id="btnSave" type="submit" class="btn btn-primary">Lưu</button>
        <a class="btn btn-secondary" href="/Owner/Rooms@(!string.IsNullOrWhiteSpace(accId) ? $"?accommodationId={accId}" : "")">Hủy</a>
    </div>
</form>

@section Scripts {
<script>
(function(){
    if (!WhaleBooking.auth.isOwner()) {
        WhaleBooking.ui.showAlert('Bạn không có quyền đăng nhập', 'danger');
        window.location.href = '/Auth/Login';
        return;
    }

    const id = '@id';

    // Rooms API endpoints
    const detailsEndpoint = `/rooms/${id}`;
    const updateInfoEndpoint = `/rooms/${id}`; // PUT JSON
    const updateImageEndpoint = `/rooms/${id}/image`; // PUT multipart

    const form = document.getElementById('frm');

    async function load(){
        const res = await WhaleBooking.api.call(detailsEndpoint, { method: 'GET' });
        const it = (res && res.data) || res;
        if (!it) return;
        form.querySelector('[name="tenPhong"]').value = it.tenPhong ?? it.TenPhong ?? '';
        form.querySelector('[name="gia"]').value = it.gia ?? it.Gia ?? '';
        form.querySelector('[name="soNguoiToiDa"]').value = it.soNguoiToiDa ?? it.SoNguoiToiDa ?? '';
        form.querySelector('[name="moTa"]').value = it.moTa ?? it.MoTa ?? '';

        // Render current images (supports many possible field names)
        const container = document.getElementById('roomImages');
        if (container) {
            container.innerHTML = '';
            let imgs = it.images ?? it.Images ?? it.imageUrls ?? it.ImageUrls ?? null;
            if (!Array.isArray(imgs)) {
                const one = it.imageUrl || it.ImageUrl;
                imgs = one ? [one] : [];
            }
            imgs.forEach(u => {
                const abs = WhaleBooking.api.fullImageUrl(u);
                const wrap = document.createElement('div');
                wrap.className = 'position-relative';
                wrap.style.display = 'inline-block';
                const img = document.createElement('img');
                img.src = abs; img.className='img-thumbnail'; img.style.maxHeight='120px';
                img.style.minHeight='80px'; img.style.objectFit='cover';
                const btn = document.createElement('button');
                btn.type='button'; btn.className='btn-close position-absolute';
                btn.style.top='-6px'; btn.style.right='-6px';
                btn.setAttribute('aria-label','Remove');
                btn.setAttribute('data-action','remove-image');
                btn.setAttribute('data-url', u); // keep original url as identifier
                wrap.appendChild(img);
                wrap.appendChild(btn);
                container.appendChild(wrap);
            });
            if (imgs.length === 0) {
                const small = document.createElement('small'); small.className='text-muted'; small.textContent='Chưa có ảnh'; container.appendChild(small);
            }
        }
    }

    form.addEventListener('submit', async function(e){
        e.preventDefault();
        // 1) Update room info (JSON)
        const priceVal = Number(form.querySelector('[name="gia"]').value);
        const body = {
            tenPhong: form.querySelector('[name="tenPhong"]').value,
            soNguoiToiDa: Number(form.querySelector('[name="soNguoiToiDa"]').value || 0),
            moTa: form.querySelector('[name="moTa"]').value
        };
        // Send both gia and giaPhong if user provided a valid number to ensure API records price history
        if (!Number.isNaN(priceVal) && priceVal > 0) {
            body.gia = priceVal;
            body.giaPhong = priceVal;
        }
        const resInfo = await WhaleBooking.api.call(updateInfoEndpoint, { method: 'PUT', body: JSON.stringify(body) });
        if (!resInfo || resInfo.success === false) {
            WhaleBooking.ui.showAlert((resInfo && resInfo.message) || 'Cập nhật thông tin thất bại', 'danger');
            return;
        }
        // 2) If new images selected, upload each sequentially to the single-image endpoint
        const filesInput = form.querySelector('input[type="file"][name="files"]');
        if (filesInput && filesInput.files && filesInput.files.length > 0) {
            for (let i = 0; i < filesInput.files.length; i++) {
                const fd = new FormData();
                fd.append('file', filesInput.files[i]);
                const resImg = await WhaleBooking.api.upload(updateImageEndpoint, fd, { method: 'PUT' });
                if (!resImg || resImg.success === false) {
                    WhaleBooking.ui.showAlert((resImg && resImg.message) || `Tải ảnh ${i+1} thất bại`, 'danger');
                    return;
                }
            }
        }
        WhaleBooking.ui.showAlert('Cập nhật phòng thành công', 'success');
        setTimeout(() => window.location.href = '/Owner/Rooms', 700);
    });

    // Delete existing image when clicking the X button
    document.getElementById('roomImages')?.addEventListener('click', async (e) => {
        const target = e.target.closest('[data-action="remove-image"]');
        if (!target) return;
        const url = target.getAttribute('data-url');
        if (!url) return;
        if (!confirm('Xóa ảnh này?')) return;
        // Try DELETE via query string first
        let ok = false;
        try {
            const res = await WhaleBooking.api.call(`/rooms/${id}/image?url=${encodeURIComponent(url)}`, { method: 'DELETE' });
            ok = !!(res && res.success !== false);
        } catch {}
        if (!ok) {
            try {
                const res2 = await WhaleBooking.api.call(`/rooms/${id}/image`, { method: 'DELETE', body: JSON.stringify({ url }) });
                ok = !!(res2 && res2.success !== false);
            } catch {}
        }
        if (ok) {
            WhaleBooking.ui.showAlert('Đã xóa ảnh', 'success');
            // remove from UI
            const wrap = target.parentElement; if (wrap) wrap.remove();
        } else {
            WhaleBooking.ui.showAlert('Xóa ảnh thất bại', 'danger');
        }
    });

    load();
})();
</script>
}
